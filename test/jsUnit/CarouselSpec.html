<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="../../js/lib/jquery.2.0.0.min.js"></script>
    <script src="vendor/mocha.js"></script>
    <script src="vendor/require.js"></script>
    <script src="config.js" ></script>

</head>
<body>
    <!--PLACEHOLDER FOR MOCHA TEST RESULTS-->
    <div id="mocha"></div>

    <!--FIXTURE HTML FOR TESTS-->
    <div id="spec-markup">
        <section class="module clearfix skycom-carousel" data-function="carousel" data-tracking-module="hero" id="hero">
            <h2 class="at">Featured News, shows or Products from around Sky</h2>
            <div class="skycom-carousel-container clearfix " >

                <section class="clearfix skycom_12 alpha tile hero-tile bg-shading dark-scheme" data-tracking-other="Sky Movies Premiere" data-tracking-pod="tile-1" >
                    <a class="slug clearfix skycom-internal" href="#avengers2" data-tracking-context="show-back" data-tracking-label="Watch The Avengers Now in 8 hours" data-tracking-theme="tracking-theme" >
                        <div class="shade "></div>
                        <figure>
                            <div data-picture="" data-alt="Heroes" class="poster rounded">
                                <img alt="Heroes" src="/hp/image/h1/desktopFront">
                            </div>
                            <figcaption class="skycom_5 skycom_6-mobile alpha cushioned overlay content">
                                <img src="http://epgstatic.sky.com/epgdata/1.0/newchanlogos/250/34/skychb1409.png" alt="Sky Movies Premiere" class="channel-logo">
                                <h3 class="skycom-focus-el " id="title-avengers2">Watch The Avengers Now in 8 hours</h3>
                                <p class="skycom-ellipsis">Watch Tonight</p>
                            </figcaption>
                        </figure>
                    </a>
                </section>

                <section class="clearfix skycom_12 alpha tile hero-tile bg-shading dark-scheme" data-tracking-other="Sky Movies Premiere" data-tracking-pod="tile-2">
                    <a class="slug clearfix skycom-internal" href="#avengers3" data-tracking-context="show-back" data-tracking-label="Watch The Avengers Now in 7 hours" data-tracking-theme="tracking-theme" >
                        <div class="shade "></div>
                        <figure>
                            <div data-picture="" data-alt="Heroes" class="poster rounded">
                                <img alt="Heroes" src="/hp/image/h1/desktopFront">
                            </div>
                            <figcaption class="skycom_5 skycom_6-mobile alpha cushioned overlay content">
                                <img src="http://epgstatic.sky.com/epgdata/1.0/newchanlogos/250/34/skychb1409.png" alt="Sky Movies Premiere" class="channel-logo">
                                <h3 class="skycom-focus-el " id="title-avengers3">Watch The Avengers Now in 7 hours</h3>
                                <p class="skycom-ellipsis">Watch Tonight</p>
                            </figcaption>
                        </figure>
                    </a>
                </section>

                <section class="clearfix skycom_12 alpha tile hero-tile bg-shading dark-scheme" data-tracking-other="Sky Movies Premiere" data-tracking-pod="tile-3" >
                    <a class="slug clearfix skycom-internal" href="#avengers4" data-tracking-context="show-back" data-tracking-label="Watch The Avengers Now in 6 hours" data-tracking-theme="tracking-theme">
                        <div class="shade "></div>
                        <figure>
                            <div data-picture="" data-alt="Heroes" class="poster rounded">
                                <img alt="Heroes" src="/hp/image/h1/desktopFront">
                            </div>
                            <figcaption class="skycom_5 skycom_6-mobile alpha cushioned overlay content">
                                <img src="http://epgstatic.sky.com/epgdata/1.0/newchanlogos/250/34/skychb1409.png" alt="Sky Movies Premiere" class="channel-logo">
                                <h3 class="skycom-focus-el " id="title-avengers4">Watch The Avengers Now in 6 hours</h3>
                                <p class="skycom-ellipsis">Watch Tonight</p>
                            </figcaption>
                        </figure>
                    </a>
                </section>
            </div>
        </section>
    </div>

    <section class="module clearfix skycom-empty-carousel" data-function="carousel" data-tracking-module="hero" id="empty-hero">
        <h2 class="at">Featured News, shows or Products from around Sky</h2>
            <div class="skycom-carousel-wrapper " >

                <section class="clearfix skycom_12 alpha tile hero-tile bg-shading dark-scheme" data-tracking-other="Sky Movies Premiere" data-tracking-pod="tile-1" >
                    <a class="slug clearfix skycom-internal" href="#avengers2" data-tracking-context="show-back" data-tracking-label="Watch The Avengers Now in 8 hours" data-tracking-theme="tracking-theme" >
                        <div class="shade "></div>
                        <figure>
                            <div data-picture="" data-alt="Heroes" class="poster rounded">
                                <img alt="Heroes" src="/hp/image/h1/desktopFront">
                            </div>
                            <figcaption class="skycom_5 skycom_6-mobile alpha cushioned overlay content">
                                <img src="http://epgstatic.sky.com/epgdata/1.0/newchanlogos/250/34/skychb1409.png" alt="Sky Movies Premiere" class="channel-logo">
                                <h3 class="skycom-focus-el " id="empty-avengers2">Watch The Avengers Now in 8 hours</h3>
                                <p class="skycom-ellipsis">Watch Tonight</p>
                            </figcaption>
                        </figure>
                    </a>
                </section>

            </div>
    </section>
    </div>
    <script>
        globalskycom = {
            browserSupport: {
                isMobile: function() {
                    return false;
                }
            }
        };
    </script>

    <!--TEST-->
    <script>

    require(['modules/carousel', '../test/jsUnit/setup'],function(){

        describe('Carousel module', function() {

            $('#hero').skycom_carousel({carousel: {autoplay:false, onPlayDelay: 0, interval: 0}});
            $('#empty-hero').skycom_carousel({autoplay:false});

            it('Creates the controls', function() {
                expect($('.skycom-carousel').children('.indicators').find('.container span').length).to.equal(3);
                expect($('.skycom-carousel').children('.actions').find('a.previous').length).to.equal(1);
                expect($('.skycom-carousel').children('.actions').find('a.next').length).to.equal(1);
                expect($('.skycom-carousel').children('.actions').find('a.play').length).to.equal(1);
                expect($('.skycom-carousel').children('.actions').find('a.pause').length).to.equal(1);
            });

            it('Doesnt create controls if there is only one slide', function() {
                expect($('.skycom-empty-carousel').children('.indicators').length).to.equal(0);
                expect($('.skycom-empty-carousel').children('.actions').find('a.previous').length).to.equal(0);
                expect($('.skycom-empty-carousel').children('.actions').find('a.next').length).to.equal(0);
                expect($('.skycom-empty-carousel').children('.actions').find('a.play').length).to.equal(0);
                expect($('.skycom-empty-carousel').children('.actions').find('a.pause').length).to.equal(0);
            });

            it('play and pause triggers work', function(){
                $('#hero').trigger('play');
                expect($('.skycom-carousel.paused').length).to.equal(0);
                $('#hero').trigger('pause');
                expect($('.skycom-carousel.paused').length).to.equal(1);
            });

            it('play and pause buttons work', function(){
                $('.skycom-carousel').children('.actions').find('a.play').click();
                expect($('.skycom-carousel.paused').length).to.equal(0);
                $('.skycom-carousel').children('.actions').find('a.pause').click();
                expect($('.skycom-carousel.paused').length).to.equal(1);
            });

            it('indicator buttons dont do anything if it is the current active tile already', function(done){
                var $activeSlide;
                $activeSlide = $('#hero').find('.skycom-carousel-container > .active')
                expect($activeSlide.index()).to.equal(0);
                $('.skycom-carousel').find('.indicators .container span').eq(0).click();
                $activeSlide = $('#hero').find('.skycom-carousel-container > .active')
                setTimeout(function() {
                    expect($activeSlide.index()).to.equal(0);
                    done()
                }, 10)
            });
            it('indicator buttons work', function(done){
                var $activeSlide;
                $activeSlide = $('#hero').find('.skycom-carousel-container > .active')
                expect($activeSlide.index()).to.equal(0);
                $('.skycom-carousel').find('.indicators .container span').eq(2).click();
                setTimeout(function() {
                    $activeSlide = $('#hero').find('.skycom-carousel-container > .active')
                    expect($activeSlide.index()).to.equal(2);
                    done()
                }, 100)
            });


            it('only the first slide can be tabbed', function(done){
                $('.skycom-carousel').find('.indicators .container span').eq(0).click();
                setTimeout(function() {
                    var $activeSlide = $('#hero').find('.skycom-carousel-container > .active'),
                            $otherSlides = $('#hero').find('.skycom-carousel-container > :not(.active)');

                    expect($activeSlide.index()).to.equal(0);
                    expect($activeSlide.find('a').length).to.equal(1);
                    expect($otherSlides.find('a').length).to.equal(2);
                    expect($otherSlides.find('a[tabindex=-1]').length).to.equal(2);
                    done();
                }, 100);

            });

            it('after pressing next, only the active slide can be tabbed', function(done){
                $('.skycom-carousel').children('.actions').find('a.next').click();
                setTimeout(function() {

                    var $activeSlide = $('#hero').find('.skycom-carousel-container > .active'),
                    $otherSlides = $('#hero').find('.skycom-carousel-container > :not(.active)');

                    expect($activeSlide.index()).to.equal(1);
                    expect($activeSlide.find('a').length).to.equal(1);
                    expect($otherSlides.find('a').length).to.equal(2);
                    expect($otherSlides.find('a[tabindex=-1]').length).to.equal(2);
                    done();
                }, 100);

            });

            it('after pressing previous, only the active slide can be tabbed', function(done){
                $('.skycom-carousel').children('.actions').find('a.previous').click();
                setTimeout(function() {

                    var $activeSlide = $('#hero').find('.skycom-carousel-container > .active'),
                    $otherSlides = $('#hero').find('.skycom-carousel-container > :not(.active)');

                    expect($activeSlide.index()).to.equal(0);
                    expect($activeSlide.find('a').length).to.equal(1);
                    expect($otherSlides.find('a').length).to.equal(2);
                    expect($otherSlides.find('a[tabindex=-1]').length).to.equal(2);
                    done();
                }, 100);
            });

            var checkActiveSlide = function(expectedSlide) {
                var $activeSlide = $('#hero').find('.skycom-carousel-container > .active');
                expect($activeSlide.index()).to.equal(expectedSlide);
            };

            var checkActiveSlideAfterAction = function(action, startExpectedSlide, endExpectedSlide, time, done) {
                setTimeout(function() {
                    checkActiveSlide(startExpectedSlide);
                    action();
                    setTimeout(function() {
                        checkActiveSlide(endExpectedSlide);
                        if (done) done();
                    }, 50);
                }, time);
            };

            it('carousel is never ending', function(done){
                $('.skycom-carousel').find('.indicators .container span').eq(2).click();
                $('.skycom-carousel').children('.actions').find('a.next').click();

                checkActiveSlideAfterAction(function() {
                    $('.skycom-carousel').find('.indicators .container span').eq(0).click();
                    $('.skycom-carousel').children('.actions').find('a.previous').click();
                }, 0, 2, 100, done);
            });

            it('re-renders markup and behaves correctly when slide is added to carousel', function() {
                $('.hero-tile').first().clone().appendTo('.skycom-carousel-container');
                expect($('.indicators .container span').length).to.equal(3);
                $('#hero').trigger('refresh');
                expect($('.indicators .container span').length).to.equal(4);
            });

            it('defaults to slide zero if refreshing to anything weird', function(done) {
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 0);}, 2, 0, 0);
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', -1);}, 0, 0, 100);
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', undefined);}, 0, 0, 200);
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 'hello');}, 0, 0, 300, done);
            });

            it('defaults to slide maximum if index is too big', function(done) {
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 666);}, 0, 3, 0, done);
            });

            it('can refresh onto any slide', function(done) {
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 1);}, 3, 1, 0);
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 3);}, 1, 3, 100);
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 2);}, 3, 2, 200);
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 2);}, 2, 2, 300);
                checkActiveSlideAfterAction(function() {$('#hero').trigger('refresh', 0);}, 2, 0, 400, done);
            });
        });
        mocha.run();
    });
    </script>

</body>
</html>